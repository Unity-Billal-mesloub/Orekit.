<!--- Copyright 2022-2025 Thales Alenia Space
  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

# Upgrading from Orekit 13.X to Orekit 14.0

Version 14.0 of Orekit introduced some incompatible API changes with respect
to versions 13.x. These changes are summarized in the following table. The next
paragraphs give hints about how users should change application source code to
adapt to this new version.

| change                                                                                                      | related issues                                                                                                                           |
|-------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------|
| [custom GNSS time systems](#Custom_GNSS_Time_Systems)                                                       | [issue 1775](https://gitlab.orekit.org/orekit/orekit/-/issues/1775)                                                                      |
| [revamping of rinex files](#Revamping_of_Rinex_Files)                                                       | [issue 1689](https://gitlab.orekit.org/orekit/orekit/-/issues/1689), [issue 1776](https://gitlab.orekit.org/orekit/orekit/-/issues/1776) |
| [fast number formatting for scientific notation](#Fast_Number_Formatting_for_Scientific_Notation)           | [issue 1780](https://gitlab.orekit.org/orekit/orekit/-/issues/1780)                                                                      |
| [created clocks package](#Created_Clocks_Package)                                                           | [issue 1802](https://gitlab.orekit.org/orekit/orekit/-/issues/1802)                                                                      |
| [add abstract class for detectors based on BodyShape](#Add_abstract_class_for_detectors_based_on_BodyShape) | [issue 1244](https://gitlab.orekit.org/orekit/orekit/-/issues/1244)                                                                      |
| [move (Field)OrbitBlender to propagation package](#Move_orbit_blender_to_propagation_package)               | [issue 1806](https://gitlab.orekit.org/orekit/orekit/-/issues/1806)                                                                      |
| [create cr3bp subpackage inside orbit](#Create_cr3bp_subpackage_inside_orbit)                               | [issue 1807](https://gitlab.orekit.org/orekit/orekit/-/issues/1807)                                                                      |
| [create covariance subpackage inside propagation](#Create_covariance_subpackage_inside_propagation)         | [issue 1789](https://gitlab.orekit.org/orekit/orekit/-/issues/1789)                                                                      |


## Custom GNSS Time Systems

### overview of the change

In the 13.X series, `TimeSystem` was an enumerate, and therefore included only
a limited set of values, preventing it to be used for custom GNSS systems that
are not yet officially recognized by IGS. `TimeSystem` has therefore been
changed to an interface to allow for custom implementations, and a new
`PredefinedTimeSystem` enumerate has been set up containing the official
implementations.

### how to adapt existing source code

If users need to initialize a value from the predefined lists (say `GALILEO` time
system), then they should use `PredefinedTimeSystem.GALILEO` enumerate constant.
If they just need to pass around a time system that has already been created (say
parsed from some file or created from scratch by a simulator), then they should
rather use the `TimeSystem` type, as it is more general and can be used for both
predefined and custom time systems.

## Revamping of Rinex Files

### overview of the change

In the 13.X series, `RinexClock` was a flat structure that was
inconsistent with `RinexObservation` and `RinexNavigation` and had no
associated writer. The leap seconds setting in all Rinex files was
also inconsistent (in fact, it is inconsistent in the standard
themselves as LEAP SECONDS in clock file does not have the same
meaning in observation and navigation files…).

Support for version 4.02 of Rinex observation and navigation files was
added in 13.X series, but only partially. A few messages could not be parsed
(NavIC ionosphere messages type L1NV, subtypes KLO and NEQN, GLONASS ionosphere
messages LXOC). There was no support for writing Rinex navigation files.

Inconsistencies in clock files and support for missing navigation messages
have been resolved by revamping the classes hierarchy, `RinexClockWriter`
`RinexNavigationWriter` and many support container classes have been created.
Note that the GLONASS L1OC and L3OC CDMA navigation messages are still not
supported (they are silently ignored when parsing navigation files).

The change mainly implies several getters that were directly in `RinexClock`
or in some navigation messages have been moved around. A new `RinexClockHeader`
has been added, and the clock comments are now regular instances of `RinexComment`
that can be accessed individually instead of being a single concatenated string.
The getters and setters for leap seconds now explicitly state whereas they
correspond to the separation between UTC and TAI or to the separation between
UTC and GNSS (really GPS). A new `IonosphereAij` intermediate container has
been added to `IonosphereNequickGMessage` (and reused in the new
`IonosphereNavICNeQuickNMessage`). In anticipation of future support for GLONASS
L1OC and L3OC CDMA navigation messages, the `GLONASSNavigationMessage` has been
renamed `GLONASSFdmaNavigationMessage`.

The change also implied that the navigation messages in the
`org.propagation.analytical.gnss.data` packages now require a message type at
construction time (`LNAV`, `CNAV`, `C2NV`…).

### how to adapt existing source code

Users should access the data from the header by first retrieving the
header using `rinexClock.getHeader()`, and then access the relevant
data (using for example `rinexClockHeader.getReceivers()`). The value
returned by `rinexClock.getComments()` is now a list of
`RinexComment`, each instance containing the line number and the
text. The `{get|set}LeapSeconds` and `{get|set}NumberOfLeapSeconds`
methods have been replaced by `{get|set}LeapSecondsTAI` and
`{get|set}LeapSecondsGNSS`. Access to the aᵢⱼ coefficients from
`IonosphereNequickGMessage` now uses an intermediate `getAij` method
to retrieve the intermediate container. References to the
`GLONASSNavigationMessage` name should be changed to the new name
`GLONASSFdmaNavigationMessage`.

If navigation messages were built from scratch (instead of being parsed
from Rinex navigation files), then the message type should be added
to the constructor call.

## Fast Number Formatting for Scientific Notation

### overview of the change

In the 13.X series, the `FastDoubleFormatter` was added, alongside
`FastLongFormatter`, for speeding up writing of large files. The double
formatter could only support decimal format, but not scientific format,
which is used for example in Rinex clock and Rinex navigation files.
This limitation has been lifted in 14.0 by adding a new `FastScientificFormatter`.

This change implied changing the existing `FastDoubleFormatter` to an abstract
class which cannot be instanciated anymore, and introducing a `FastDecimalFormatter`
class. Both `FastDecimalFormatter` and `FastScientificFormatter` extend the
`FastDoubleFormatter` abstract class and can be instanciated.

### how to adapt existing source code

Users who built `FastDecimalFormatter` instances should now build
`FastDecimalFormatter` instances. Users who only used already built instances
can keep their variables declared as `FastDoubleFormatter` instances.

## Created Clocks Package

### overview of the change

In the 13.X series, the most classes related to clock models were in the
`org.orekit.time` package. Two classes related to quadratic models were
in the `org.orekit.estimation.measurements` package.

As more and more models are added, these became cumbersome, so a dedicated package
`org.orekit.time.clock` has been created. The existing classes were moved there
and new models added in 14.0 were created there too.

### how to adapt existing source code

Users of clock models and clock offsets just need to update their import statements
to get the class from their new package.

## Add abstract class for detectors based on BodyShape

### overview of the change

There was some code duplication and inconsistencies in naming between the following classes:
`(Field)AltitudeDetector`, `(Field)LongitudeCrossingDetector`, `(Field)LongitudeRangeCrossingDetector`, 
`(Field)LongitudeExtremumDetector`, `(Field)LatitudeCrossingDetector`, `(Field)LatitudeRangeCrossingDetector`,
`(Field)LatitudeExtremumDetector`.

An abstract class has been introduced for the standard detectors and the Field ones.

### how to adapt existing source code

The consequence is that the getter is now called `getBodyShape` and returns a `BodyShape.`
Please change your calls consequently.


## Move (Field)OrbitBlender to propagation package

### overview of the change

`OrbitBlender` and `(Field)OrbitBlender` depend on classes inside propagation.
They have been moved to this package.

### how to adapt existing source code

Change the imports by replacing "orbit" with "propagation".

## Create cr3bp subpackage inside orbit

### overview of the change

The package orbit had classes related to the third-body problem with dependencies to the propagation package.
For a cleaner architecture, they have been moved to a new subpackage, called cr3bp. 
This mirrors what is already done inside propagation.

### how to adapt existing source code

Change the imports by replacing "orbit" with "orbit.cr3bp" for the following classes:
`LibrationOrbit`, `LibrationOrbitFamily`, `LibrationOrbitType`, `LyapunovOrbit`, `RichardsonExpansion`,
`CR3BPDifferentialCorrection`, `HaloOrbit`

## Create covariance subpackage inside propagation

### overview of the change

Covariance-related code has been growing recently, but still seated at the root of propagation. 
It now has its own subpackage.

### how to adapt existing source code

Change the imports by replacing "propagation" with "propagation.covariance" for 
 `LinearKeplerianCovarianceMapper`, `LinearKeplerianCovarianceHandler`, `AbstractStateCovarianceInterpolator`,
`FieldStateCovariance` and all the `StateCovariance[...]` classes.

